<div class="container">
  <nz-spin [nzSpinning]="loading">
    <form nz-form [formGroup]="validateForm" nzLayout="vertical">
      <nz-form-item>
        <nz-form-label>商品封面</nz-form-label>
        <nz-form-control>
          <app-customer-file-list [props]="fileParams" formControlName="cover_pic"></app-customer-file-list>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzRequired>商品名称</nz-form-label>
        <nz-form-control nzErrorTip="请输入商品名称">
          <input nz-input formControlName="name" placeholder="请输入商品名称" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzRequired>商品标识</nz-form-label>
        <nz-form-control [nzErrorTip]="codeErrorTpl">
          <input nz-input formControlName="code" placeholder="请输入商品标识" />
          <div class="mt-1 text-xs text-gray-500">商品标识应由字母、数字、下划线组成，用于唯一标识商品</div>
          <ng-template #codeErrorTpl let-control>
            <ng-container *ngIf="control.hasError('required')">请输入商品标识</ng-container>
            <ng-container *ngIf="control.hasError('pattern')">商品标识格式不正确，应由字母、数字组成</ng-container>
          </ng-template>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzRequired>商品价格列表</nz-form-label>
        <nz-form-control>
          <div formArrayName="price_list" class="space-y-3">
            @for (priceItem of priceList.controls; track $index) {
              <div [formGroupName]="$index" class="flex items-start gap-2 p-3 bg-gray-50 rounded-lg border border-gray-200">
                <div class="flex-1 space-y-2">
                  <div>
                    <label class="text-xs text-gray-600 mb-1 block">价格</label>
                    <nz-input-number
                      formControlName="price"
                      [nzMin]="0"
                      [nzStep]="0.01"
                      [nzPlaceHolder]="'请输入价格'"
                      [nzFormatter]="priceFormatter"
                      [nzParser]="priceParser"
                      class="w-full">
                    </nz-input-number>
                    @if (priceItem.get('price')?.invalid && priceItem.get('price')?.touched) {
                      <div class="text-xs text-red-500 mt-1">请输入有效价格</div>
                    }
                  </div>
                  <div>
                    <label class="text-xs text-gray-600 mb-1 block">价格文案</label>
                    <input
                      nz-input
                      formControlName="price_text"
                      placeholder="例如：默认方案、高清大图等"
                      class="w-full"
                    />
                    @if (priceItem.get('price_text')?.invalid && priceItem.get('price_text')?.touched) {
                      <div class="text-xs text-red-500 mt-1">请输入价格文案</div>
                    }
                  </div>
                </div>
                <button
                  nz-button
                  nzType="text"
                  nzDanger
                  (click)="removePriceItem($index)"
                  class="mt-6"
                  [disabled]="priceList.length === 1">
                  <nz-icon nzType="delete" nzTheme="outline"></nz-icon>
                </button>
              </div>
            }
          </div>
          <button
            nz-button
            nzType="dashed"
            (click)="addPriceItem()"
            class="w-full mt-3">
            <nz-icon nzType="plus" nzTheme="outline"></nz-icon>
            添加价格项
          </button>
          <div class="text-gray-400 mt-2 text-xs">可以添加多个价格选项，每个价格对应不同的时长或规格</div>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label>商品描述</nz-form-label>
        <nz-form-control>
          <textarea nz-input formControlName="desc" placeholder="请输入商品描述"
            [nzAutosize]="{ minRows: 3, maxRows: 6 }"></textarea>
          <div class="text-gray-400 mt-1 text-xs">描述商品的功能特点、使用说明等信息</div>
        </nz-form-control>
      </nz-form-item>
    </form>
  </nz-spin>
</div>

<div class="button">
  <button [disabled]="loading" (click)="close()" nz-button type="reset" nzType="default" nzSize="default">取消</button>
  <button [disabled]="loading" (click)="submit()" nz-button nzType="primary" nzSize="default">提交</button>
</div>
