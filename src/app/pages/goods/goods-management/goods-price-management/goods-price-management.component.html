<div class="container">
  <nz-spin [nzSpinning]="loading">
    <!-- 商品信息 -->
    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
      <div class="flex items-center gap-3">
        @if (goods.cover_pic) {
        <img class="w-16 h-16 rounded" [src]="goods.cover_pic.url" alt="">
        } @else {
        <div class="w-16 h-16 bg-gray-200 rounded flex items-center justify-center">
          <nz-icon nzType="gift" nzTheme="twotone" class="text-2xl" [nzTwotoneColor]="'#52c41a'"></nz-icon>
        </div>
        }
        <div class="flex-1">
          <div class="text-lg font-semibold text-gray-900">{{ goods.name }}</div>
          <div class="text-sm text-gray-500 mt-1">商品标识: {{ goods.code }}</div>
        </div>
      </div>
    </div>

    <!-- 价格列表表单 -->
    <form [formGroup]="priceForm">
      <div formArrayName="price_list" class="space-y-3">
        @for (priceItem of priceList.controls; track $index) {
        <div [formGroupName]="$index" class="p-4 bg-white rounded-lg border border-gray-200 hover:border-blue-300 transition-colors">
          <div class="space-y-3">
            <div>
              <label class="text-sm text-gray-700 font-medium mb-1 block">价格</label>
              <nz-input-number
                formControlName="price"
                [nzMin]="0"
                [nzStep]="0.01"
                [nzPlaceHolder]="'请输入价格'"
                [nzFormatter]="priceFormatter"
                [nzParser]="priceParser"
                class="w-full">
              </nz-input-number>
              @if (priceItem.get('price')?.invalid && priceItem.get('price')?.touched) {
              <div class="text-xs text-red-500 mt-1">请输入有效价格</div>
              }
            </div>
            <div>
              <label class="text-sm text-gray-700 font-medium mb-1 block">价格文案</label>
              <input
                nz-input
                formControlName="price_text"
                placeholder="例如：默认方案、高清大图等"
                class="w-full"
              />
              @if (priceItem.get('price_text')?.invalid && priceItem.get('price_text')?.touched) {
              <div class="text-xs text-red-500 mt-1">请输入价格文案</div>
              }
            </div>
            <!-- 状态显示 -->
            <div class="flex items-center gap-3">
              <label class="text-sm text-gray-700 font-medium">状态:</label>
              @if (priceItem.get('id')?.value) {
                <!-- 已有价格项：可切换状态的开关 -->
                <nz-switch
                  [ngModel]="(priceItem.get('status')?.value ?? 1) === 1"
                  (ngModelChange)="onStatusChange($index, $event)"
                  [ngModelOptions]="{standalone: true}"
                  nzCheckedChildren="启用"
                  nzUnCheckedChildren="禁用">
                </nz-switch>
              } @else {
                <!-- 新增价格项：禁用的开关，默认启用 -->
                <nz-switch
                  [ngModel]="true"
                  [nzDisabled]="true"
                  nzCheckedChildren="启用"
                  nzUnCheckedChildren="禁用">
                </nz-switch>
                <span class="text-xs text-gray-500">保存后可切换</span>
              }
            </div>
          </div>
        </div>
        }
      </div>

      <!-- 添加按钮 -->
      <button
        nz-button
        nzType="dashed"
        nzBlock
        nzSize="large"
        (click)="addPriceItem()"
        class="h-16 mt-3">
        <nz-icon nzType="plus" nzTheme="outline"></nz-icon>
        添加新价格
      </button>

      <!-- 空状态 -->
      @if (priceList.length === 0) {
      <nz-empty nzNotFoundContent="暂无价格数据，点击上方按钮添加价格" class="my-8"></nz-empty>
      }
    </form>
  </nz-spin>
</div>

<div class="button">
  <button [disabled]="loading" (click)="close()" nz-button nzType="default" nzSize="default">取消</button>
  <button [disabled]="loading" (click)="save()" nz-button nzType="primary" nzSize="default">保存</button>
</div>
