<!-- user-management.component.html -->
<div class="flex justify-between items-center py-4 border-b border-gray-100 px-2 sm:px-0">
  <div class="flex gap-4">
    <div
      class="w-10 h-10 flex justify-center items-center rounded-full border border-[#EBEBEB] bg-white shadow-[0_1px_2px_0_rgba(10,13,20,0.03)] flex-shrink-0">
      <nz-icon class="text-[16px]" nzType="team" nzTheme="outline" />
    </div>
    <div class="flex flex-col gap-0 min-w-0">
      <div class="text-base sm:text-lg font-semibold text-[#0A0D14] truncate">用户管理</div>
      <div class="text-xs text-[#6B7280] truncate">管理系统用户和代币余额</div>
    </div>
  </div>
</div>

<!-- 筛选器 -->
<div class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 sm:p-6 my-4 sm:my-6">
  <div class="flex items-center gap-2 mb-4">
    <nz-icon nzType="filter" nzTheme="outline" class="text-gray-500"></nz-icon>
    <span class="text-sm font-medium text-gray-700">筛选条件</span>
  </div>

  <!-- 第一行：5个筛选条件 -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
    <div class="flex flex-col gap-2">
      <label class="text-xs text-gray-500 font-medium">状态</label>
      <nz-select nzAllowClear [(ngModel)]="filters.status" nzPlaceHolder="全部状态" class="w-full rounded-[4px]">
        <nz-option [nzValue]="1" nzLabel="启用"></nz-option>
        <nz-option [nzValue]="0" nzLabel="禁用"></nz-option>
      </nz-select>
    </div>

    <div class="flex flex-col gap-2">
      <label class="text-xs text-gray-500 font-medium">来源类型</label>
      <nz-select
        nzAllowClear
        [(ngModel)]="filters.source_type"
        nzPlaceHolder="全部来源"
        class="w-full rounded-[4px]"
      >
        <nz-option *ngFor="let option of sourceTypeOptions" [nzValue]="option.id" [nzLabel]="option.name"></nz-option>
      </nz-select>
    </div>

    <div class="flex flex-col gap-2">
      <label class="text-xs text-gray-500 font-medium">用户ID</label>
      <input
        nz-input
        [(ngModel)]="filters.user_id"
        placeholder="请输入用户ID"
        class="w-full rounded-[4px]"
      />
    </div>

    <div class="flex flex-col gap-2">
      <label class="text-xs text-gray-500 font-medium">邀请人ID</label>
      <input
        nz-input
        [(ngModel)]="filters.inviter_id"
        placeholder="请输入邀请人ID"
        class="w-full rounded-[4px]"
      />
    </div>

    <div class="flex flex-col gap-2">
      <label class="text-xs text-gray-500 font-medium">用户昵称</label>
      <input
        nz-input
        [(ngModel)]="filters.nickname"
        placeholder="请输入用户昵称"
        class="w-full rounded-[4px]"
      />
    </div>
  </div>

  <!-- 第二行：日期选择器和按钮 -->
  <div class="flex flex-row gap-4 mt-4 items-end flex-wrap">
    <div class="flex flex-col gap-2 ">
      <label class="text-xs text-gray-500 font-medium">注册时间</label>
      <app-date-label
        [(ngModel)]="filters.created_at_range"
        [labelRight]="false"
        mode="date"
        class="w-full"
      ></app-date-label>
    </div>

    <div class="flex flex-col gap-2 ">
      <label class="text-xs text-gray-500 font-medium">最后登录时间</label>
      <app-date-label
        [(ngModel)]="filters.last_login_at_range"
        [labelRight]="false"
        mode="date"
        class="w-full"
      ></app-date-label>
    </div>

    <div class="flex gap-2">
      <button nz-button nzType="primary" (click)="applyFilters()" [nzLoading]="loading">
        <nz-icon nzType="search" nzTheme="outline"></nz-icon>
        查询
      </button>
      <button nz-button nzType="default" (click)="resetFilters()">
        <nz-icon nzType="reload" nzTheme="outline"></nz-icon>
        重置
      </button>
    </div>
  </div>
</div>

<!-- 用户列表 -->
<div>
  <nz-spin [nzSpinning]="loading">
    <div *ngIf="viewMode === 'table'" class="bg-white rounded-lg border border-gray-200 shadow-sm">
      <nz-table
        #basicTable
        [nzData]="filteredUsers"
        [nzLoading]="loading"
        [nzFrontPagination]="false"
        [nzTotal]="total"
        [nzPageIndex]="pageIndex"
        [nzPageSize]="pageSize"
        (nzPageIndexChange)="onPageIndexChange($event)"
        (nzPageSizeChange)="onPageSizeChange($event)"
        (nzQueryParams)="onQueryParamsChange($event)"
        [nzScroll]="{ x: '1200px' }"
        class="w-full"
      >
        <thead>
          <tr>
            <th nzWidth="80px">ID</th>
            <th nzWidth="200px">用户信息</th>
            <th nzColumnKey="token_balance" [nzSortFn]="true" nzWidth="120px">代币余额</th>
            <th nzWidth="120px">邀请人ID</th>
            <th nzWidth="120px">来源类型</th>
            <th nzWidth="180px">注册时间</th>
            <th nzWidth="180px">最后登录</th>
            <th nzWidth="100px">状态</th>
            <th nzWidth="120px" nzRight>操作</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of basicTable.data">
            <td>{{ user.id }}</td>
            <td>
              <div class="flex items-center">
                <nz-avatar [nzSize]="32" [nzSrc]="user.avatar || '/assets/avatar.png'" class="mr-3 flex-shrink-0"></nz-avatar>
                <div class="min-w-0 flex-1">
                  <div class="font-medium truncate" [class.text-gray-400]="!user.nickname">
                    {{ user.nickname || '暂无昵称' }}
                  </div>
                </div>
              </div>
            </td>
            <td>
              <span class="text-blue-600 font-medium">{{ user.token_balance }}</span>
            </td>
            <td>
              <span class="truncate block">{{ user.inviter_id || '-' }}</span>
            </td>
            <td>
              <span class="text-gray-600 truncate block">{{ getSourceTypeName(user.source_type) }}</span>
            </td>
            <td>
              <span class="whitespace-nowrap text-xs">{{ user.created_at | date:'yyyy-MM-dd HH:mm:ss' }}</span>
            </td>
            <td>
              <span class="whitespace-nowrap text-xs">{{ user.last_login_at | date:'yyyy-MM-dd HH:mm:ss' }}</span>
            </td>
            <td>
              <nz-tag [nzColor]="user.status === 1 ? 'success' : 'error'">
                {{ user.status === 1 ? '启用' : '禁用' }}
              </nz-tag>
            </td>
            <td nzRight>
              <div class="flex gap-2">
                <button nz-button nzType="primary" nzSize="small" (click)="viewUserDetail(user)">
                  <nz-icon nzType="eye" nzTheme="outline"></nz-icon>
                  查看
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </nz-table>
    </div>
  </nz-spin>
</div>
